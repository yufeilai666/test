name: update_xml_2_test-epg_N_py_2_tvepg-epg_scripts

###############################################################################
# EPGæ•°æ®è‡ªåŠ¨ç”Ÿæˆå·¥ä½œæµ
# 
# åŠŸèƒ½æ¦‚è¿°:
#   - ä»ç§æœ‰ä»“åº“è·å–EPGç”Ÿæˆè„šæœ¬ï¼ˆPHP/Pythonï¼‰
#   - è‡ªåŠ¨æ‰§è¡Œè„šæœ¬ç”ŸæˆXMLæ ¼å¼çš„ç”µå­èŠ‚ç›®æŒ‡å—æ•°æ®
#   - å°†ç”Ÿæˆçš„EPGæ•°æ®æ¨é€åˆ°å½“å‰ä»“åº“çš„epgç›®å½•
#   - å°†ç”Ÿæˆçš„Pythonå¤‡ä»½æ–‡ä»¶æ¨é€åˆ°ç§æœ‰ä»“åº“tvepgçš„epg_scriptsåˆ†æ”¯
#
# ä¸»è¦ç‰¹æ€§:
#   - æ”¯æŒå¤šè¯­è¨€å¤šè„šæœ¬ï¼ˆPHP 8.1 + Python 3.9ï¼‰
#   - å®‰å…¨çš„ç§æœ‰ä»“åº“è®¿é—®ï¼ˆä½¿ç”¨PAT_TOKENï¼‰
#   - è‡ªåŠ¨é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Šæœºåˆ¶
#   - è„šæœ¬æ‰§è¡Œåè‡ªåŠ¨æ¸…ç†ï¼Œä¸ä¿ç•™åœ¨å…¬å…±ä»“åº“
#   - åŒ—äº¬æ—¶é—´æˆ³çš„æäº¤ä¿¡æ¯
#   - å¯é…ç½®çš„è„šæœ¬æ‰§è¡Œåˆ—è¡¨å’Œä¾èµ–è„šæœ¬åˆ—è¡¨
#   - æ”¯æŒåŠ¨æ€å’Œé™æ€ä¾èµ–æ–‡ä»¶å¤„ç†
#   - æ”¯æŒæ‰€æœ‰ç”Ÿæˆæ–‡ä»¶ç±»å‹ï¼ˆ.py, .xml, .xml.gzç­‰ï¼‰
#   - æ”¯æŒåŒå‘åŒæ­¥ï¼šä»ç§æœ‰ä»“åº“æ‹‰å–è„šæœ¬ï¼Œå¹¶å°†ç”Ÿæˆæ–‡ä»¶æ¨é€å›ç§æœ‰ä»“åº“
#
# è§¦å‘æ¡ä»¶:
#   - å®šæ—¶è§¦å‘: æ¯æ—¥UTC 19:10ï¼ˆåŒ—äº¬æ—¶é—´3:10ï¼‰è‡ªåŠ¨è¿è¡Œ
#   - æ‰‹åŠ¨è§¦å‘: å¯åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨æ‰§è¡Œ
#
# å‰ç½®è¦æ±‚:
#   - åœ¨ä»“åº“Secretsä¸­è®¾ç½®PAT_TOKENï¼Œå…·æœ‰è®¿é—®ç§æœ‰ä»“åº“çš„æƒé™
#   - ç§æœ‰ä»“åº“tvepgçš„epg_scriptsåˆ†æ”¯åŒ…å«æ‰€éœ€çš„EPGè„šæœ¬
#
# è¾“å‡ºç»“æœ:
#   - ç”Ÿæˆçš„XMLæ–‡ä»¶å°†ä¿å­˜åœ¨epgç›®å½•ä¸­
#   - ç”Ÿæˆçš„Pythonå¤‡ä»½æ–‡ä»¶å°†æ¨é€å›ç§æœ‰ä»“åº“
#   - è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯æŠ¥å‘Š
###############################################################################

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ - å¯åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  # schedule:
    # å®šæ—¶è§¦å‘ - æ¯å¤©UTCæ—¶é—´19ç‚¹10åˆ†ï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹10åˆ†ï¼‰è‡ªåŠ¨è¿è¡Œ
    # - cron: '10 19 * * *'

jobs:
  generate-epg:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆUbuntuç³»ç»Ÿä½œä¸ºè¿è¡Œç¯å¢ƒ
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œè¿›è¡Œè®¤è¯
        fetch-depth: 1  # è·å–æœ€æ–°gitå†å²è®°å½•

    # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # æŒ‡å®šPython 3.9ç‰ˆæœ¬

    # æ­¥éª¤3: è®¾ç½®PHPç¯å¢ƒ
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'  # æŒ‡å®šPHP 8.1ç‰ˆæœ¬
        
    # æ­¥éª¤4: å®‰è£…Pythonä¾èµ–åŒ…
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip  # å‡çº§pipåˆ°æœ€æ–°ç‰ˆæœ¬
        # å®‰è£…Pythonè„šæœ¬å¯èƒ½éœ€è¦çš„åº“
        pip install requests beautifulsoup4 lxml pytz httpx aiohttp loguru

    # æ­¥éª¤5: å®‰è£…PHPæ‰©å±•
    - name: Install PHP dependencies
      run: |
        # æ›´æ–°åŒ…ç®¡ç†å™¨
        sudo apt-get update
        # å®‰è£…PHPè„šæœ¬å¯èƒ½éœ€è¦çš„æ‰©å±•
        sudo apt-get install -y php-curl php-xml php-mbstring        

    # æ­¥éª¤6: æ£€å‡ºç§æœ‰ä»“åº“çš„epg_scriptsåˆ†æ”¯
    - name: Checkout private repository (epg_scripts branch)
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/tvepg  # ç§æœ‰ä»“åº“
        token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œ
        ref: epg_scripts  # æŒ‡å®šåˆ†æ”¯
        path: private_repo_temp  # æ£€å‡ºåˆ°æŒ‡å®šç›®å½•

    # æ­¥éª¤7: ä»ç§æœ‰ä»“åº“å¤åˆ¶ä¾èµ–è„šæœ¬æ–‡ä»¶
    - name: Copy dependency scripts from private repository
      id: copy-dependencies
      run: |
        echo "ğŸ“ ä»ç§æœ‰ä»“åº“å¤åˆ¶ä¾èµ–è„šæœ¬æ–‡ä»¶..."
        
        # å®šä¹‰éœ€è¦å¤åˆ¶çš„ä¾èµ–è„šæœ¬æ•°ç»„
        # å¯ä»¥æ ¹æ®éœ€è¦è½»æ¾æ·»åŠ ã€ç§»é™¤æˆ–æ³¨é‡Šä¾èµ–è„šæœ¬
        dependency_scripts=(
          # Pythonä¾èµ–è„šæœ¬
          "bbcable_backup_channels_dict.py"
          # å¯ä»¥æ·»åŠ æ›´å¤šä¾èµ–è„šæœ¬
          "tvmao_channels_list.py"
          # "config.json"
        )
        
        # å­˜å‚¨æˆåŠŸå¤åˆ¶çš„ä¾èµ–è„šæœ¬
        copied_dependencies=""
        
        # å­˜å‚¨å¤±è´¥çš„ä¾èµ–è„šæœ¬
        failed_dependencies=""
        
        # è®°å½•å¤åˆ¶å‰çš„æ–‡ä»¶çŠ¶æ€ï¼ˆç”¨äºåç»­æ£€æµ‹å“ªäº›æ–‡ä»¶æ˜¯å¤åˆ¶çš„ä¾èµ–æ–‡ä»¶ï¼‰
        echo "DEPENDENCY_FILES_START" > .dependencies_marker
        echo "ä»¥ä¸‹æ–‡ä»¶æ˜¯å¤åˆ¶çš„ä¾èµ–æ–‡ä»¶:" >> .dependencies_marker
        
        # å¾ªç¯å¤åˆ¶æ¯ä¸ªä¾èµ–è„šæœ¬
        for dependency in "${dependency_scripts[@]}"; do
          echo "ğŸ“‹ å¤„ç†ä¾èµ–è„šæœ¬: $dependency"
          
          # æ£€æŸ¥ä¾èµ–è„šæœ¬åœ¨ç§æœ‰ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨
          if [ -f "private_repo_temp/$dependency" ]; then
            # å¤åˆ¶ä¾èµ–è„šæœ¬åˆ°å½“å‰å·¥ä½œç›®å½•
            cp "private_repo_temp/$dependency" "./$dependency"
            
            # è®°å½•è¿™ä¸ªæ–‡ä»¶æ˜¯ä¾èµ–æ–‡ä»¶
            echo "$dependency" >> .dependencies_marker
            
            copied_dependencies="$copied_dependencies $dependency"
            echo "âœ… å·²å¤åˆ¶ä¾èµ–è„šæœ¬: $dependency"
          else
            echo "âŒ é”™è¯¯: ç§æœ‰ä»“åº“ä¸­æœªæ‰¾åˆ°ä¾èµ–è„šæœ¬ $dependency"
            failed_dependencies="$failed_dependencies $dependency"
            
            # å¯¹äºæŸäº›å…³é”®ä¾èµ–æ–‡ä»¶ï¼Œå¯ä»¥åˆ›å»ºé»˜è®¤æ–‡ä»¶ä»¥å…è®¸ç»§ç»­æ‰§è¡Œ
            if [[ "$dependency" == *"bbcable_backup_channels_dict.py"* ]]; then
              echo "âš ï¸ åˆ›å»ºç©ºå­—å…¸æ–‡ä»¶ä»¥ä¾¿ç»§ç»­æ‰§è¡Œ: $dependency"
              echo 'backup_channels_dict = {}' > "$dependency"
              echo "$dependency" >> .dependencies_marker  # è®°å½•è¿™ä¸ªç”Ÿæˆçš„é»˜è®¤æ–‡ä»¶ä¹Ÿæ˜¯ä¾èµ–æ–‡ä»¶
              copied_dependencies="$copied_dependencies $dependency"
            fi
          fi
        done
        
        echo "DEPENDENCY_FILES_END" >> .dependencies_marker
        
        echo "===================================="
        echo "ğŸ“Š ä¾èµ–è„šæœ¬å¤åˆ¶ç»“æœ:"
        if [ -n "$copied_dependencies" ]; then
          echo "âœ… æˆåŠŸå¤åˆ¶çš„ä¾èµ–è„šæœ¬:$copied_dependencies"
          # å°†å¤åˆ¶çš„ä¾èµ–è„šæœ¬åˆ—è¡¨ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "COPIED_DEPENDENCIES='$copied_dependencies'" >> $GITHUB_ENV
        else
          echo "â„¹ï¸ æ²¡æœ‰æˆåŠŸå¤åˆ¶ä»»ä½•ä¾èµ–è„šæœ¬"
          echo "COPIED_DEPENDENCIES=''" >> $GITHUB_ENV
        fi
        
        if [ -n "$failed_dependencies" ]; then
          echo "âŒ å¤åˆ¶å¤±è´¥çš„ä¾èµ–è„šæœ¬:$failed_dependencies"
          # ä¿å­˜å¤±è´¥åˆ—è¡¨åˆ°ç¯å¢ƒå˜é‡
          echo "FAILED_DEPENDENCIES='$failed_dependencies'" >> $GITHUB_ENV
          echo "âš ï¸ è­¦å‘Š: éƒ¨åˆ†ä¾èµ–è„šæœ¬ç¼ºå¤±ï¼Œå¯èƒ½ä¼šå½±å“åç»­è„šæœ¬æ‰§è¡Œ"
        else
          echo "âœ… æ‰€æœ‰ä¾èµ–è„šæœ¬å¤åˆ¶æˆåŠŸ"
          echo "FAILED_DEPENDENCIES=''" >> $GITHUB_ENV
        fi
        
        echo "===================================="

    # æ­¥éª¤8: å®šä¹‰å¹¶æ‰§è¡Œä¸»è„šæœ¬æ•°ç»„
    - name: Define and execute main scripts
      id: execute-scripts
      run: |
        # å®šä¹‰è¦è·å–å¹¶æ‰§è¡Œçš„ä¸»è„šæœ¬æ•°ç»„ï¼ˆPHPå’ŒPythonï¼‰
        # å¯ä»¥è½»æ¾æ·»åŠ ã€ç§»é™¤æˆ–æ³¨é‡Šä¸éœ€è¦çš„è„šæœ¬
        scripts=(
          # "get_bbcable_backup_channels_dict.py"  # è·å–BBå®½é¢‘å¤šä¸ªé¢‘é“çš„å­—å…¸
          # "epganywhereusa.php"
          # "epg-fixer.php"          # PHP EPGä¿®å¤å™¨è„šæœ¬ï¼ˆä»EPG_CONFIGè¯»å–é…ç½®ï¼‰
          # "epgguangxi.php"         # PHP å¹¿è¥¿EPGè„šæœ¬
          # "get_mytvsuper_epg.py"      # Python mytvsuper EPGè„šæœ¬
          "get_mod_epg.py"
          "get_bbcable_epg.py"
          "get_kbro_epg.py"
          "get_celestial_epg.py"
          "get_tvmao_epg.py"
        )
        
        # è®°å½•æ‰§è¡Œå‰çš„æ–‡ä»¶åˆ—è¡¨
        echo "ğŸ“ è®°å½•æ‰§è¡Œå‰çš„æ–‡ä»¶åˆ—è¡¨..."
        find . -maxdepth 1 -type f \( -name "*.py" -o -name "*.php" -o -name "*.txt" -o -name "*.json" \) | sed 's|^\./||' > .files_before.txt
        echo "æ‰§è¡Œå‰æ–‡ä»¶åˆ—è¡¨å·²ä¿å­˜åˆ° .files_before.txt"
        echo "===================================="
        
        # å­˜å‚¨å¤±è´¥è„šæœ¬çš„æ•°ç»„ï¼Œç”¨äºé”™è¯¯æŠ¥å‘Š
        failed_scripts=()
        
        # å­˜å‚¨ç”Ÿæˆçš„æ–‡ä»¶ä¿¡æ¯
        generated_files_for_private_repo=""  # éœ€è¦æ¨é€åˆ°ç§æœ‰ä»“åº“çš„æ–‡ä»¶
        generated_files_for_current_repo=""  # éœ€è¦ä¿ç•™åœ¨å½“å‰ä»“åº“çš„æ–‡ä»¶
        
        # å¾ªç¯æ‰§è¡Œæ¯ä¸ªä¸»è„šæœ¬
        for script in "${scripts[@]}"; do
          echo "::group::ğŸ›  æ‰§è¡Œ $script"
          
          # æ£€æŸ¥è„šæœ¬åœ¨ç§æœ‰ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨
          if [ ! -f "private_repo_temp/$script" ]; then
            echo "âš ï¸ è­¦å‘Š: è„šæœ¬ $script ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            failed_scripts+=("$script (ä¸å­˜åœ¨)")
            echo "::endgroup::"
            continue
          fi
          
          # å¤åˆ¶è„šæœ¬ä»ä¸´æ—¶ç›®å½•åˆ°å½“å‰å·¥ä½œç›®å½•
          cp "private_repo_temp/$script" "./$script"
          
          # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©æ‰§è¡Œæ–¹å¼
          if [[ "$script" == *.php ]]; then
            # æ‰§è¡ŒPHPè„šæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™è®°å½•é”™è¯¯
            php "$script" || {
              echo "âŒ é”™è¯¯: PHPè„šæœ¬ $script æ‰§è¡Œå¤±è´¥"
              failed_scripts+=("$script")
              rm -f "$script"  # æ¸…ç†è„šæœ¬æ–‡ä»¶
              echo "::endgroup::"
              continue
            }
          elif [[ "$script" == *.py ]]; then
            # æ‰§è¡ŒPythonè„šæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™è®°å½•é”™è¯¯
            python_output=$(python "$script" 2>&1)
            python_exit_code=$?
            
            if [ $python_exit_code -eq 0 ]; then
              echo "$python_output"
            else
              echo "âŒ é”™è¯¯: Pythonè„šæœ¬ $script æ‰§è¡Œå¤±è´¥"
              echo "è¾“å‡º: $python_output"
              failed_scripts+=("$script")
              rm -f "$script"  # æ¸…ç†è„šæœ¬æ–‡ä»¶
              echo "::endgroup::"
              continue
            fi
          fi
          
          # æ‰§è¡ŒæˆåŠŸååˆ é™¤ä¸»è„šæœ¬æ–‡ä»¶ï¼Œä¸ä¿ç•™åœ¨ä»“åº“ä¸­
          rm -f "$script"
          echo "âœ… ä¸»è„šæœ¬ $script æ‰§è¡ŒæˆåŠŸ"
          echo "::endgroup::"
        done
        
        # è®°å½•æ‰§è¡Œåçš„æ–‡ä»¶åˆ—è¡¨
        echo "ğŸ“ è®°å½•æ‰§è¡Œåçš„æ–‡ä»¶åˆ—è¡¨..."
        find . -maxdepth 1 -type f \( -name "*.py" -o -name "*.php" -o -name "*.txt" -o -name "*.json" -o -name "*.xml" -o -name "*.xml.gz" \) | sed 's|^\./||' > .files_after.txt
        
        # è¯†åˆ«æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆæ‰§è¡Œåå­˜åœ¨ä½†æ‰§è¡Œå‰ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼‰
        echo "ğŸ” æ£€æµ‹æ–°ç”Ÿæˆçš„æ–‡ä»¶..."
        while IFS= read -r file; do
          # è·³è¿‡ç©ºè¡Œå’Œæ ‡è®°æ–‡ä»¶
          if [ -z "$file" ] || [[ "$file" == ".dependencies_marker" ]] || [[ "$file" == ".files_before.txt" ]] || [[ "$file" == ".files_after.txt" ]]; then
            continue
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨æ‰§è¡Œå‰ä¸å­˜åœ¨
          if ! grep -qxF "$file" .files_before.txt; then
            echo "ğŸ“ æ£€æµ‹åˆ°æ–°ç”Ÿæˆçš„æ–‡ä»¶: $file"
            
            # æ ¹æ®æ–‡ä»¶ç±»å‹åˆ†ç±»
            if [[ "$file" == *.py ]] || [[ "$file" == *.php ]]; then
              # è¿™äº›ç±»å‹çš„æ–‡ä»¶åº”è¯¥æ¨é€åˆ°ç§æœ‰ä»“åº“
              generated_files_for_private_repo="$generated_files_for_private_repo $file"
            elif [[ "$file" == *.xml ]] || [[ "$file" == *.xml.gz ]]; then
              # XMLæ–‡ä»¶åº”è¯¥ä¿ç•™åœ¨å½“å‰ä»“åº“çš„epgç›®å½•
              generated_files_for_current_repo="$generated_files_for_current_repo $file"
            fi
          fi
        done < .files_after.txt
        
        # æ£€æµ‹ä¾èµ–æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹ï¼ˆæ¯”è¾ƒæ–‡ä»¶å†…å®¹ï¼‰
        echo "ğŸ” æ£€æµ‹ä¾èµ–æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹..."
        if [ -f ".dependencies_marker" ]; then
          # æå–ä¾èµ–æ–‡ä»¶åˆ—è¡¨
          dependency_files=$(sed -n '/DEPENDENCY_FILES_START/,/DEPENDENCY_FILES_END/p' .dependencies_marker | grep -v "DEPENDENCY_FILES" | grep -v "^$")
          
          for dep_file in $dependency_files; do
            if [ -f "$dep_file" ]; then
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨ç§æœ‰ä»“åº“ä¸­ä¹Ÿæœ‰å¯¹åº”çš„æ–‡ä»¶
              if [ -f "private_repo_temp/$dep_file" ]; then
                # æ¯”è¾ƒå½“å‰æ–‡ä»¶å’Œç§æœ‰ä»“åº“ä¸­çš„åŸå§‹æ–‡ä»¶
                if ! cmp -s "$dep_file" "private_repo_temp/$dep_file"; then
                  echo "ğŸ“ ä¾èµ–æ–‡ä»¶è¢«ä¿®æ”¹: $dep_file"
                  generated_files_for_private_repo="$generated_files_for_private_repo $dep_file"
                else
                  echo "â„¹ï¸ ä¾èµ–æ–‡ä»¶æœªä¿®æ”¹: $dep_file"
                fi
              else
                # å¦‚æœç§æœ‰ä»“åº“ä¸­æ²¡æœ‰å¯¹åº”æ–‡ä»¶ï¼Œä½†è¿™ä¸ªæ–‡ä»¶æ˜¯æˆ‘ä»¬åˆ›å»ºçš„é»˜è®¤æ–‡ä»¶
                # æ£€æŸ¥å®ƒæ˜¯å¦ä¸ºç©ºæ–‡ä»¶ï¼ˆé»˜è®¤çš„backup_channels_dictï¼‰
                if [[ "$dep_file" == *"bbcable_backup_channels_dict.py"* ]]; then
                  file_content=$(cat "$dep_file" 2>/dev/null | tr -d '[:space:]')
                  if [ "$file_content" = "backup_channels_dict={}" ]; then
                    echo "â„¹ï¸ é»˜è®¤ä¾èµ–æ–‡ä»¶æœªä¿®æ”¹: $dep_file"
                  else
                    echo "ğŸ“ é»˜è®¤ä¾èµ–æ–‡ä»¶è¢«ä¿®æ”¹: $dep_file"
                    generated_files_for_private_repo="$generated_files_for_private_repo $dep_file"
                  fi
                fi
              fi
            fi
          done
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f .files_before.txt .files_after.txt .dependencies_marker
        
        # æ¸…ç†å¤åˆ¶çš„ä¾èµ–æ–‡ä»¶
        echo "===================================="
        echo "ğŸ§¹ æ¸…ç†ä¾èµ–è„šæœ¬æ–‡ä»¶..."
        
        if [ -n "${{ env.COPIED_DEPENDENCIES }}" ]; then
          echo "ä»ç¯å¢ƒå˜é‡è·å–å¤åˆ¶çš„ä¾èµ–è„šæœ¬: ${{ env.COPIED_DEPENDENCIES }}"
          
          # å°†ä¾èµ–è„šæœ¬å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„
          IFS=' ' read -r -a dependency_array <<< "${{ env.COPIED_DEPENDENCIES }}"
          
          for dependency in "${dependency_array[@]}"; do
            if [ -n "$dependency" ] && [ -f "$dependency" ]; then
              # æ£€æŸ¥è¿™ä¸ªä¾èµ–æ–‡ä»¶æ˜¯å¦éœ€è¦æ¨é€åˆ°ç§æœ‰ä»“åº“
              if [[ ! " $generated_files_for_private_repo " =~ " $dependency " ]]; then
                # ä¸éœ€è¦æ¨é€ï¼Œå¯ä»¥æ¸…ç†
                rm -f "$dependency"
                echo "âœ… å·²æ¸…ç†æœªä¿®æ”¹çš„ä¾èµ–æ–‡ä»¶: $dependency"
              else
                echo "â„¹ï¸ ä¾èµ–æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œä¿ç•™ç”¨äºæ¨é€ç§æœ‰ä»“åº“: $dependency"
              fi
            fi
          done
        fi
        
        echo "âœ… æ–‡ä»¶æ¸…ç†å®Œæˆ!"
        
        # å¤„ç†æ–‡ä»¶åˆ—è¡¨ï¼Œç§»é™¤é¦–å°¾ç©ºæ ¼
        if [ -n "$generated_files_for_private_repo" ]; then
          generated_files_for_private_repo=$(echo $generated_files_for_private_repo | sed 's/^ *//;s/ *$//')
          echo "PRIVATE_REPO_FILES='$generated_files_for_private_repo'" >> $GITHUB_ENV
          echo "HAS_PRIVATE_REPO_FILES=true" >> $GITHUB_ENV
        else
          echo "PRIVATE_REPO_FILES=''" >> $GITHUB_ENV
          echo "HAS_PRIVATE_REPO_FILES=false" >> $GITHUB_ENV
        fi
        
        if [ -n "$generated_files_for_current_repo" ]; then
          generated_files_for_current_repo=$(echo $generated_files_for_current_repo | sed 's/^ *//;s/ *$//')
          echo "CURRENT_REPO_FILES='$generated_files_for_current_repo'" >> $GITHUB_ENV
          echo "HAS_CURRENT_REPO_FILES=true" >> $GITHUB_ENV
        else
          echo "CURRENT_REPO_FILES=''" >> $GITHUB_ENV
          echo "HAS_CURRENT_REPO_FILES=false" >> $GITHUB_ENV
        fi
        
        # æŠ¥å‘Šæ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œç»“æœ
        echo "=== è„šæœ¬æ‰§è¡Œç»“æœ ==="
        if [ ${#failed_scripts[@]} -eq 0 ]; then
          echo "âœ… æ‰€æœ‰ä¸»è„šæœ¬æ‰§è¡ŒæˆåŠŸ!"
          
          # æŠ¥å‘Šä¾èµ–è„šæœ¬çŠ¶æ€
          if [ -n "${{ env.FAILED_DEPENDENCIES }}" ]; then
            echo "âš ï¸ è­¦å‘Š: ä»¥ä¸‹ä¾èµ–è„šæœ¬å¤åˆ¶å¤±è´¥: ${{ env.FAILED_DEPENDENCIES }}"
          fi
          
          # æŠ¥å‘Šç”Ÿæˆçš„æ–‡ä»¶
          if [ -n "$generated_files_for_private_repo" ]; then
            echo "ğŸ“ éœ€è¦æ¨é€åˆ°ç§æœ‰ä»“åº“çš„æ–‡ä»¶: $generated_files_for_private_repo"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æ¨é€åˆ°ç§æœ‰ä»“åº“çš„æ–‡ä»¶"
          fi
          
          if [ -n "$generated_files_for_current_repo" ]; then
            echo "ğŸ“ éœ€è¦ä¿ç•™åœ¨å½“å‰ä»“åº“çš„æ–‡ä»¶: $generated_files_for_current_repo"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦ä¿ç•™åœ¨å½“å‰ä»“åº“çš„æ–‡ä»¶"
          fi
          
        else
          echo "â„¹ï¸ ä»¥ä¸‹ä¸»è„šæœ¬æ‰§è¡Œå¤±è´¥:"
          for failed in "${failed_scripts[@]}"; do
            echo "  - $failed"
          done
          
          # æŠ¥å‘Šä¾èµ–è„šæœ¬çŠ¶æ€
          if [ -n "${{ env.FAILED_DEPENDENCIES }}" ]; then
            echo "âš ï¸ è­¦å‘Š: ä»¥ä¸‹ä¾èµ–è„šæœ¬å¤åˆ¶å¤±è´¥: ${{ env.FAILED_DEPENDENCIES }}"
          fi
          
          # å¦‚æœæœ‰è„šæœ¬å¤±è´¥ï¼Œé€€å‡ºçŠ¶æ€ä¸ºéé›¶ï¼Œä½¿å·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥
          exit 1
        fi

    # æ­¥éª¤9: å¤åˆ¶éœ€è¦æ¨é€åˆ°ç§æœ‰ä»“åº“çš„æ–‡ä»¶
    - name: Copy files to private repository directory
      if: env.HAS_PRIVATE_REPO_FILES == 'true'
      env:
        PRIVATE_REPO_FILES: ${{ env.PRIVATE_REPO_FILES }}
      run: |
        echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°ç§æœ‰ä»“åº“ç›®å½•..."
        echo "éœ€è¦å¤åˆ¶çš„æ–‡ä»¶: $PRIVATE_REPO_FILES"
        
        IFS=' ' read -r -a files_array <<< "$PRIVATE_REPO_FILES"
        
        for file in "${files_array[@]}"; do
          if [ -f "$file" ]; then
            cp "$file" "private_repo_temp/$file"
            echo "âœ… å·²å¤åˆ¶: $file -> private_repo_temp/$file"
          else
            echo "âš ï¸ è­¦å‘Š: æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•å¤åˆ¶: $file"
          fi
        done

    # æ­¥éª¤10: æ¨é€ç”Ÿæˆçš„æ–‡ä»¶åˆ°ç§æœ‰ä»“åº“
    - name: Push generated files to private repository
      if: env.HAS_PRIVATE_REPO_FILES == 'true'
      run: |
        echo "ğŸš€ å‡†å¤‡æ¨é€ç”Ÿæˆçš„æ–‡ä»¶åˆ°ç§æœ‰ä»“åº“..."
        
        # è¿›å…¥ç§æœ‰ä»“åº“ç›®å½•
        cd private_repo_temp
        
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºç§æœ‰ä»“åº“æäº¤ï¼‰
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # æ‹‰å–æœ€æ–°æ›´æ”¹ï¼Œé¿å…å†²çª
        git pull origin epg_scripts
        
        # è·å–åŒ—äº¬æ—¶é—´
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "â„¹ï¸ ç§æœ‰ä»“åº“æ²¡æœ‰æ›´æ”¹å¯æäº¤"
        else
          # æäº¤æ›´æ”¹ï¼ŒåŒ…å«åŒ—äº¬æ—¶é—´ä¿¡æ¯
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°è„šæœ¬ç”Ÿæˆçš„æ–‡ä»¶ [åŒ—äº¬æ—¶é—´: $BEIJING_TIME]"
          
          # æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“çš„epg_scriptsåˆ†æ”¯
          git push origin epg_scripts
          
          echo "âœ… æˆåŠŸæ¨é€ç”Ÿæˆçš„æ–‡ä»¶åˆ°ç§æœ‰ä»“åº“ tvepg/epg_scripts åˆ†æ”¯"
          
          # è¾“å‡ºæ¨é€çš„æ–‡ä»¶åˆ—è¡¨
          echo "ğŸ“‹ æ¨é€çš„æ–‡ä»¶åˆ—è¡¨:"
          git show --name-only --pretty="" HEAD
        fi
        
        # è¿”å›å·¥ä½œç›®å½•
        cd ..

    # æ­¥éª¤11: æ¸…ç†ä¸´æ—¶ç›®å½•
    - name: Clean up temporary directories
      run: |
        # æ¸…ç†ç§æœ‰ä»“åº“ä¸´æ—¶ç›®å½•
        rm -rf private_repo_temp
        echo "âœ… ä¸´æ—¶ç›®å½•å·²æ¸…ç†"

    # æ­¥éª¤12: åˆ›å»ºepgç›®å½•å¹¶ç§»åŠ¨XMLæ–‡ä»¶
    - name: Create epg directory and move XML files
      if: env.HAS_CURRENT_REPO_FILES == 'true'
      env:
        CURRENT_REPO_FILES: ${{ env.CURRENT_REPO_FILES }}
      run: |
        echo "ğŸ“ åˆ›å»ºepgç›®å½•å¹¶ç§»åŠ¨XMLæ–‡ä»¶..."
        echo "éœ€è¦ç§»åŠ¨çš„æ–‡ä»¶: $CURRENT_REPO_FILES"
        
        # åˆ›å»ºepgç›®å½•
        mkdir -p epg
        
        # ç§»åŠ¨XMLå’ŒXML.GZæ–‡ä»¶åˆ°epgç›®å½•
        IFS=' ' read -r -a files_array <<< "$CURRENT_REPO_FILES"
        
        for file in "${files_array[@]}"; do
          if [ -f "$file" ]; then
            mv "$file" "epg/"
            echo "âœ… å·²ç§»åŠ¨: $file -> epg/"
          fi
        done
        
        # åŒæ—¶æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„XMLæ–‡ä»¶ï¼ˆä»¥é˜²æœ‰é—æ¼ï¼‰
        find . -maxdepth 1 -name "*.xml" -exec mv {} epg/ \; 2>/dev/null || echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°å…¶ä»–XMLæ–‡ä»¶"
        find . -maxdepth 1 -name "*.xml.gz" -exec mv {} epg/ \; 2>/dev/null || echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°å…¶ä»–XML.GZæ–‡ä»¶"
        
        echo "ğŸ“Š epgç›®å½•å†…å®¹:"
        ls -la epg/

    # æ­¥éª¤13: é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆå½“å‰ä»“åº“ï¼‰
    - name: Configure Git for current repository
      run: |
        git config user.name "GitHub Actions"  # è®¾ç½®æäº¤è€…åç§°
        git config user.email "actions@github.com"  # è®¾ç½®æäº¤è€…é‚®ç®±

    # æ­¥éª¤14: è·å–åŒ—äº¬æ—¶é—´å¹¶æäº¤æ›´æ”¹åˆ°å½“å‰ä»“åº“
    - name: Get Beijing time and commit changes to current repository
      run: |
        # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´å¹¶è·å–æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')
        
        # æ£€æŸ¥epgç›®å½•æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
        if [ -d "epg" ] && [ "$(ls -A epg 2>/dev/null)" ]; then
          # æ·»åŠ epgç›®å½•ä¸‹çš„æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒº
          git add epg/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸ å½“å‰ä»“åº“æ²¡æœ‰æ›´æ”¹å¯æäº¤"
          else
            # æäº¤æ›´æ”¹ï¼ŒåŒ…å«åŒ—äº¬æ—¶é—´ä¿¡æ¯
            git commit -m "ğŸ”„ Download EPGæ•°æ® [åŒ—äº¬æ—¶é—´: $BEIJING_TIME]"
            
            # æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
            git push
            
            echo "âœ… å½“å‰ä»“åº“PushæˆåŠŸ"
            
            # æ˜¾ç¤ºæäº¤çš„æ–‡ä»¶åˆ—è¡¨
            echo "ğŸ“‹ æäº¤çš„æ–‡ä»¶åˆ—è¡¨:"
            git show --name-only --pretty="" HEAD
          fi
        else
          echo "â„¹ï¸ epgç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œæ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
        fi