name: 1 Generate and Deploy TV M3U Files

on:
  schedule:
    # æ¯4ä¸ªå°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 */4 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
  # å½“è„šæœ¬æ–‡ä»¶æˆ–é…ç½®æ–‡ä»¶æœ‰æ›´æ”¹æ—¶ä¹Ÿè§¦å‘
  push:
    paths:
      - 'scripts/generate_tv12_m3u.py'
      - 'scripts/generate_m3u.py'
      - 'files.json'

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install requests zhconv chardet

    - name: Run TV12 M3U generation script with retry
      continue-on-error: true  # å³ä½¿æ­¤æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
      id: run_tv12_script
      run: |
        cd scripts
        max_retries=3
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          echo "ğŸš€ å°è¯•ç¬¬ $((retry_count+1)) æ¬¡æ‰§è¡Œ TV12 è„šæœ¬..."
          
          if python generate_tv12_m3u.py; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… TV12è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            exit 0
          else
            retry_count=$((retry_count+1))
            if [ $retry_count -lt $max_retries ]; then
              echo "âš ï¸ TV12è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œç­‰å¾… 30 ç§’åé‡è¯•..."
              sleep 30
            fi
          fi
        done
        
        echo "status=failed" >> $GITHUB_OUTPUT
        echo "âŒ TV12è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $max_retries"
        exit 0  # ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤

    - name: Run general M3U generation script with retry
      continue-on-error: true  # å³ä½¿æ­¤æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
      id: run_general_script
      run: |
        cd scripts
        max_retries=3
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          echo "ğŸš€ å°è¯•ç¬¬ $((retry_count+1)) æ¬¡æ‰§è¡Œé€šç”¨è„šæœ¬..."
          
          if python generate_m3u.py; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… é€šç”¨è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            exit 0
          else
            retry_count=$((retry_count+1))
            if [ $retry_count -lt $max_retries ]; then
              echo "âš ï¸ é€šç”¨è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œç­‰å¾… 30 ç§’åé‡è¯•..."
              sleep 30
            fi
          fi
        done
        
        echo "status=failed" >> $GITHUB_OUTPUT
        echo "âŒ é€šç”¨è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $max_retries"
        exit 0  # ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤

    - name: List generated M3U files
      run: |
        echo "ğŸ“‘ Generated M3U files:"
        ls -la *.m3u 2>/dev/null || echo "âš ï¸ No M3U files found in root directory"
        ls -la scripts/*.m3u 2>/dev/null || echo "âš ï¸ No M3U files found in scripts directory"

    - name: Move M3U files to root directory
      run: |
        # ç§»åŠ¨æ‰€æœ‰åœ¨scriptsç›®å½•ä¸­ç”Ÿæˆçš„M3Uæ–‡ä»¶åˆ°æ ¹ç›®å½•
        if ls scripts/*.m3u 1> /dev/null 2>&1; then
          mv scripts/*.m3u ./
        fi
        
        # æ£€æŸ¥æ ¹ç›®å½•æ˜¯å¦å·²ç»æœ‰M3Uæ–‡ä»¶
        echo "ğŸ“‘ M3U files in root directory after moving:"
        ls -la *.m3u 2>/dev/null || echo "âš ï¸ No M3U files in root directory"

    - name: Check if any script succeeded
      id: check_success
      run: |
        tv12_status="${{ steps.run_tv12_script.outputs.status }}"
        general_status="${{ steps.run_general_script.outputs.status }}"
        
        if [ "$tv12_status" = "success" ] || [ "$general_status" = "success" ]; then
          echo "has_success=true" >> $GITHUB_OUTPUT
          echo "âœ… è‡³å°‘æœ‰ä¸€ä¸ªè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "has_success=false" >> $GITHUB_OUTPUT
          echo "âŒ æ‰€æœ‰è„šæœ¬éƒ½æ‰§è¡Œå¤±è´¥"
        fi

    - name: Commit and push if changed
      if: steps.check_success.outputs.has_success == 'true'
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ‰€æœ‰M3Uæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        git add *.m3u
        if ! git diff --staged --quiet; then
          # è·å–åŒ—äº¬æ—¶é—´
          BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          echo "âŒšï¸ å½“å‰åŒ—äº¬æ—¶é—´ï¼š$BEIJING_TIME"
          
          git commit -m "ğŸ”„ Auto-generated TV M3U files [$BEIJING_TIME UTC+8] [skip ci]"
          
          # æ·»åŠ  push é‡è¯•æœºåˆ¶
          max_push_retries=3
          push_retry_count=0
          push_success=false
          
          while [ $push_retry_count -lt $max_push_retries ] && [ "$push_success" = false ]; do
            echo "ğŸ“¤ å°è¯•ç¬¬ $((push_retry_count+1)) æ¬¡æ¨é€æ›´æ”¹..."
            
            if git push origin HEAD:main; then
              echo "âœ… Changes pushed to repository successfully"
              push_success=true
            else
              push_retry_count=$((push_retry_count+1))
              if [ $push_retry_count -lt $max_push_retries ]; then
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œç­‰å¾… 10 ç§’åé‡è¯•..."
                sleep 10
                
                # å°è¯•æ‹‰å–æœ€æ–°æ›´æ”¹å¹¶é‡æ–°æ¨é€
                echo "ğŸ“© å°è¯•æ‹‰å–æœ€æ–°æ›´æ”¹..."
                if git pull --rebase origin main; then
                  echo "âœ… æ‹‰å–æˆåŠŸï¼Œé‡æ–°å°è¯•æ¨é€..."
                else
                  echo "â„¹ï¸ æ‹‰å–å¤±è´¥ï¼Œè·³è¿‡æ­¤æ­¥éª¤ç›´æ¥é‡è¯•æ¨é€..."
                fi
              fi
            fi
          done
          
          if [ "$push_success" = false ]; then
            echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° $max_push_retries"
            exit 1
          fi
        else
          echo "â„¹ï¸ No changes to commit"
        fi

    - name: Show summary
      run: |
        echo "=== WORKFLOW SUMMARY ==="
        echo "TV12è„šæœ¬çŠ¶æ€: ${{ steps.run_tv12_script.outputs.status }}"
        echo "é€šç”¨è„šæœ¬çŠ¶æ€: ${{ steps.run_general_script.outputs.status }}"
        echo "ç”Ÿæˆçš„M3Uæ–‡ä»¶:"
        ls -la *.m3u 2>/dev/null || echo "No M3U files generated"
        echo "========================"

    - name: Fail if all scripts failed
      if: steps.check_success.outputs.has_success == 'false'
      run: |
        echo "âŒ æ‰€æœ‰è„šæœ¬éƒ½æ‰§è¡Œå¤±è´¥ï¼Œå·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥"
        exit 1