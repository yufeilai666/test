# æ–‡ä»¶: .github/workflows/3.3-multi-script-epg-generator.yml
# åŠŸèƒ½: å¼¹æ€§å¤šè„šæœ¬EPGç”Ÿæˆå™¨ï¼ˆæ”¯æŒPHPå’ŒPythonï¼‰- è·¨ä»“åº“ç‰ˆæœ¬
# æè¿°:
#   æ­¤å·¥ä½œæµåœ¨å…¬å¼€ä»“åº“è¿è¡Œï¼Œä½†ï¼š
#     1. ä»ç§æœ‰ä»“åº“çš„epg_scriptsåˆ†æ”¯è·å–è„šæœ¬
#     2. åœ¨å…¬å¼€ä»“åº“ä¸­æ‰§è¡Œè„šæœ¬ç”ŸæˆEPG XMLæ–‡ä»¶
#     3. å°†ç”Ÿæˆçš„XMLæ–‡ä»¶æ¨é€å›ç§æœ‰ä»“åº“
#
# ä½¿ç”¨è¯´æ˜:
#   1. åœ¨å…¬å¼€ä»“åº“çš„secretsä¸­é…ç½®:
#      - PAT_TOKEN: å…·æœ‰è®¿é—®ç§æœ‰ä»“åº“æƒé™çš„Personal Access Token
#      - TMDB_API_KEY: TMDB APIå¯†é’¥
#      - EPG_CONFIG: EPGé…ç½®ä¿¡æ¯
#   2. è„šæœ¬æ–‡ä»¶å­˜å‚¨åœ¨ç§æœ‰ä»“åº“çš„epg_scriptsåˆ†æ”¯
#   3. ç”Ÿæˆçš„XMLæ–‡ä»¶å°†æ¨é€å›ç§æœ‰ä»“åº“çš„ä¸»åˆ†æ”¯

name: 3.3 Resilient Multi-Script EPG Generator (Cross-Repository)

# è§¦å‘æ¡ä»¶é…ç½®
on:
  schedule:
    - cron: '5 1,5,9,13,17,21 * * *'
  workflow_dispatch:

# ä½œä¸šå®šä¹‰
jobs:
  generate-epg:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # ç¯å¢ƒå˜é‡é…ç½®
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      EPG_CONFIG: ${{ secrets.EPG_CONFIG }}
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
      PRIVATE_REPO: "yufeilai666/tvepg"  # ç§æœ‰ä»“åº“åç§°
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºç§æœ‰ä»“åº“çš„epg_scriptsåˆ†æ”¯åˆ°ä¸´æ—¶ç›®å½•
    - name: Checkout private repo scripts branch
      uses: actions/checkout@v4
      with:
        repository: ${{ env.PRIVATE_REPO }}
        ref: epg_scripts
        path: ./epg-scripts-temp
        token: ${{ secrets.PAT_TOKEN }}

    # æ­¥éª¤2: æ£€å‡ºç§æœ‰ä»“åº“çš„ä¸»åˆ†æ”¯åˆ°å¦ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼ˆç”¨äºæ¨é€ï¼‰
    - name: Checkout private repo main branch
      uses: actions/checkout@v4
      with:
        repository: ${{ env.PRIVATE_REPO }}
        ref: main
        path: ./private-repo
        token: ${{ secrets.PAT_TOKEN }}

    # æ­¥éª¤3: è®¾ç½®PHPç¯å¢ƒ
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, xmlreader, zlib, curl, pcntl

    # æ­¥éª¤4: è®¾ç½®Pythonç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # æ­¥éª¤5: å®‰è£…Pythonä¾èµ–
    - name: Install Python dependencies
      run: |
        cd ./epg-scripts-temp
        pip install requests beautifulsoup4 tmdbv3api lxml aiohttp aiofiles
        cd ..

    # æ­¥éª¤6: åœ¨è„šæœ¬ç›®å½•ä¸­ç”ŸæˆXMLæ–‡ä»¶
    - name: Generate XML Files in Scripts Directory
      id: generate-step
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # åˆ‡æ¢åˆ°è„šæœ¬ç›®å½•
        cd ./epg-scripts-temp
        
        # å®šä¹‰è¦æ‰§è¡Œçš„è„šæœ¬æ•°ç»„
        scripts=(
          "epg-generator.php"
          "epg-fixer.php"
        )
        
        # å­˜å‚¨å¤±è´¥è„šæœ¬çš„æ•°ç»„
        failed_scripts=()
        
        # å¾ªç¯æ‰§è¡Œæ‰€æœ‰è„šæœ¬
        for script in "${scripts[@]}"; do
          echo "::group::æ‰§è¡Œ $script"
          echo "=== å¼€å§‹æ‰§è¡Œ: $script ==="
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$script" ]; then
            echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $script"
            failed_scripts+=("$script")
            echo "::endgroup::"
            continue
          fi
          
          # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©æ‰§è¡Œæ–¹å¼
          script_extension="${script##*.}"
          
          set +e
          
          if [ "$script_extension" = "php" ]; then
            output=$(php -f "$script" 2>&1)
            exit_code=$?
          elif [ "$script_extension" = "py" ]; then
            output=$(python "$script" 2>&1)
            exit_code=$?
          else
            echo "âŒ ä¸æ”¯æŒçš„è„šæœ¬ç±»å‹: $script_extension"
            failed_scripts+=("$script")
            set -e
            echo "::endgroup::"
            continue
          fi
          
          set -e
          
          # æ‰“å°è„šæœ¬è¾“å‡º
          echo "$output"
          echo "::endgroup::"
          
          # å¤±è´¥åˆ¤å®šæ¡ä»¶
          if [ $exit_code -ne 0 ]; then
            echo "âŒ $script æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $exit_code)"
            failed_scripts+=("$script")
          elif [ "$script" = "epg-fixer.php" ]; then
            if echo "$output" | grep -q -E "(é”™è¯¯ï¼šEPG_CONFIGç¯å¢ƒå˜é‡æœªè®¾ç½®|é”™è¯¯ï¼šæ— æ³•è§£æEPG_CONFIGç¯å¢ƒå˜é‡ä¸­çš„JSONæ•°æ®|é”™è¯¯ï¼šEPG_CONFIGä¸­æœªæ‰¾åˆ°chuanliu.xmlå’Œcqunicom.xmlé…ç½®|é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„EPGæºé…ç½®|é”™è¯¯ï¼šå¿…éœ€æ‰©å±•æœªå¯ç”¨)"; then
              echo "âŒ $script ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯"
              failed_scripts+=("$script")
            elif echo "$output" | grep -q -E "(Fatal error|è‡´å‘½é”™è¯¯|Uncaught Exception|æœªæ•è·çš„å¼‚å¸¸|æ— æ³•åŠ è½½XMLå†…å®¹|XMLè§£æé”™è¯¯|ä¸‹è½½å¤±è´¥|è§£å‹å¤±è´¥|ä¿å­˜å¤±è´¥)"; then
              echo "âŒ $script æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°ä¸¥é‡é”™è¯¯"
              failed_scripts+=("$script")
            elif echo "$output" | grep -q "å¤„ç†çŠ¶æ€: å®Œå…¨å¤±è´¥"; then
              echo "âŒ $script æ‰€æœ‰æºå¤„ç†å¤±è´¥"
              failed_scripts+=("$script")
            elif echo "$output" | grep -q "å¤„ç†çŠ¶æ€: éƒ¨åˆ†æˆåŠŸ"; then
              echo "âš ï¸ $script éƒ¨åˆ†æˆåŠŸï¼ˆæœ‰å¤±è´¥æºï¼‰"
            else
              echo "âœ… $script æ‰§è¡ŒæˆåŠŸ"
            fi
          elif echo "$output" | grep -q -E "(Fatal error|è‡´å‘½é”™è¯¯|Uncaught Exception|æœªæ•è·çš„å¼‚å¸¸|å¿…éœ€æ‰©å±•æœªå¯ç”¨|æ— æ³•åŠ è½½XMLå†…å®¹|XMLè§£æé”™è¯¯|ä¸‹è½½å¤±è´¥|è§£å‹å¤±è´¥|ä¿å­˜å¤±è´¥|Traceback|Error|Exception)"; then
            echo "âŒ $script è¾“å‡ºä¸­åŒ…å«ä¸¥é‡é”™è¯¯ä¿¡æ¯"
            failed_scripts+=("$script")
          elif echo "$output" | grep -q -E "(ERROR|é”™è¯¯:)" && echo "$output" | grep -q -E "(ä¸‹è½½|è§£å‹|ä¿å­˜|å¤„ç†|è·å–|è¿æ¥)"; then
            echo "âŒ $script è¾“å‡ºä¸­åŒ…å«æ“ä½œé”™è¯¯ä¿¡æ¯"
            failed_scripts+=("$script")
          else
            echo "âœ… $script æ‰§è¡ŒæˆåŠŸ"
          fi
          
          echo "==================================="
        done
        
        # å°†ç”Ÿæˆçš„XMLæ–‡ä»¶å¤åˆ¶åˆ°ç§æœ‰ä»“åº“ç›®å½•
        if ls *.xml 1> /dev/null 2>&1; then
          echo "ğŸ›  å¤åˆ¶XMLæ–‡ä»¶åˆ°ç§æœ‰ä»“åº“ç›®å½•..."
          cp -v *.xml ../private-repo/
          echo "ğŸ“ å¤åˆ¶çš„æ–‡ä»¶:"
          ls -la *.xml
        else
          echo "âš ï¸ æœªæ‰¾åˆ°XMLæ–‡ä»¶"
        fi
        
        # è¿”å›å·¥ä½œç›®å½•
        cd ..
        
        # å¦‚æœæœ‰å¤±è´¥è„šæœ¬ï¼Œè½¬æ¢ä¸ºé€—å·åˆ†éš”å­—ç¬¦ä¸²
        if [ ${#failed_scripts[@]} -gt 0 ]; then
          failed_list=$(IFS=','; echo "${failed_scripts[*]}")
          echo "ğŸ“„ å¤±è´¥è„šæœ¬: $failed_list"
          echo "failed_scripts=$failed_list" >> $GITHUB_OUTPUT
        fi

    # æ­¥éª¤7: åˆ—å‡ºç§æœ‰ä»“åº“ç›®å½•çš„å˜æ›´æ–‡ä»¶
    - name: List changed files in private repo
      run: |
        echo "ğŸ“ ç§æœ‰ä»“åº“ç›®å½•çš„å˜æ›´æ–‡ä»¶:"
        cd ./private-repo
        git status --porcelain
        echo "ğŸ— å½“å‰ç›®å½•çš„XMLæ–‡ä»¶:"
        ls -la *.xml 2>/dev/null || echo "âš ï¸ æ— XMLæ–‡ä»¶"
        cd ..

    # æ­¥éª¤8: æäº¤å’Œæ¨é€åˆ°ç§æœ‰ä»“åº“
    - name: Commit and Push to Private Repository
      if: always()
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        PRIVATE_REPO: ${{ env.PRIVATE_REPO }}
      run: |
        # è¿›å…¥ç§æœ‰ä»“åº“ç›®å½•
        cd ./private-repo
        
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # è®¾ç½®å¸¦è®¤è¯çš„è¿œç¨‹URLï¼ˆæŒ‡å‘ç§æœ‰ä»“åº“ï¼‰
        git remote set-url origin https://x-access-token:$PAT_TOKEN@github.com/$PRIVATE_REPO.git
        
        # æ·»åŠ æ‰€æœ‰XMLæ–‡ä»¶å˜æ›´
        git add --all *.xml
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°XMLæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        # è·å–å¤±è´¥è„šæœ¬ä¿¡æ¯
        failed_scripts="${{ steps.generate-step.outputs.failed_scripts }}"
        
        # æ„é€ æäº¤ä¿¡æ¯
        now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        commit_msg="âœ… è‡ªåŠ¨æ›´æ–° EPG æ–‡ä»¶: $now_time"
        
        # å¦‚æœæœ‰å¤±è´¥è„šæœ¬ï¼Œåœ¨æäº¤ä¿¡æ¯ä¸­æ³¨æ˜
        if [ -n "$failed_scripts" ]; then
          commit_msg+=" (âš ï¸ éƒ¨åˆ†å¤±è´¥: ${failed_scripts})"
        fi
        
        # æäº¤å˜æ›´
        echo "â„¹ï¸ æäº¤ä¿¡æ¯: $commit_msg"
        git commit -m "$commit_msg"
        
        # æ¨é€é‡è¯•æœºåˆ¶
        max_retries=3
        retry_delay=5
        
        for ((i=1; i<=max_retries; i++)); do
          echo "â„¹ï¸ æ¨é€å°è¯• ($i/$max_retries)"
          
          # å…ˆæ‹‰å–æœ€æ–°å˜æ›´é¿å…å†²çª
          git pull --rebase origin main
          
          # å°è¯•æ¨é€åˆ°ç§æœ‰ä»“åº“
          if git push origin main; then
            echo "âœ… æ¨é€åˆ°ç§æœ‰ä»“åº“æˆåŠŸ"
            
            # åˆ—å‡ºæ›´æ–°çš„æ–‡ä»¶
            updated_files=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å˜æ›´åˆ—è¡¨")
            echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
            echo "$updated_files"
            
            break
          fi
          
          if [ $i -eq $max_retries ]; then
            echo "âŒ é”™è¯¯ï¼šæ¨é€åˆ°ç§æœ‰ä»“åº“å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
            exit 1
          fi
          
          echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œ${retry_delay}ç§’åé‡è¯•..."
          sleep $retry_delay
        done

    # æ­¥éª¤9: æŠ¥å‘Šç”ŸæˆçŠ¶æ€
    - name: Report Generation Status
      if: ${{ always() }}
      run: |
        failed_scripts="${{ steps.generate-step.outputs.failed_scripts }}"
        
        if [ -n "$failed_scripts" ]; then
          IFS=',' read -ra failed_array <<< "$failed_scripts"
          
          echo "::group::âŒ å¤±è´¥è„šæœ¬åˆ—è¡¨"
          for script in "${failed_array[@]}"; do
            echo "$script"
          done
          echo "::endgroup::"
          
          echo "::error::æœ‰ ${#failed_array[@]} ä¸ªè„šæœ¬æ‰§è¡Œå¤±è´¥"
          
          # æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªè„šæœ¬æˆåŠŸç”Ÿæˆäº†æ–‡ä»¶
          if ls ./private-repo/*.xml 1> /dev/null 2>&1; then
            echo "â„¹ï¸ æœ‰è„šæœ¬å¤±è´¥ï¼Œå·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥"
            echo "â„¹ï¸ æˆåŠŸç”Ÿæˆäº†éƒ¨åˆ†EPGæ–‡ä»¶å¹¶å·²æ¨é€åˆ°ç§æœ‰ä»“åº“"
          else
            echo "âŒ æ‰€æœ‰è„šæœ¬å‡å¤±è´¥ï¼Œæ— EPGæ–‡ä»¶ç”Ÿæˆ"
          fi
          
          exit 1
        else
          echo "âœ… æ‰€æœ‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          echo "âœ… EPGæ–‡ä»¶å·²æˆåŠŸæ¨é€åˆ°ç§æœ‰ä»“åº“"
        fi