# æ–‡ä»¶: .github/workflows/3-multi-script-epg-generator.yml
# åŠŸèƒ½: å¼¹æ€§å¤šè„šæœ¬EPGç”Ÿæˆå™¨ï¼ˆæ”¯æŒPHPå’ŒPythonï¼‰
# æè¿°:
#   æ­¤å·¥ä½œæµæ¯å°æ—¶è‡ªåŠ¨æ‰§è¡Œå¤šä¸ªPHPå’ŒPythonè„šæœ¬ç”Ÿæˆå’Œä¿®å¤EPG XMLæ–‡ä»¶
#   ä¸»è¦ç‰¹ç‚¹:
#     1. æ”¯æŒå®šæ—¶è§¦å‘å’Œæ‰‹åŠ¨è§¦å‘
#     2. é«˜æ•ˆå¤„ç†PHPå’ŒPythonè„šæœ¬æ‰§è¡Œ
#     3. ç²¾ç¡®è®°å½•å¤±è´¥è„šæœ¬å¹¶æ˜¾ç¤ºåœ¨æäº¤å†å²å’Œæ—¥å¿—ä¸­
#     4. æ™ºèƒ½æäº¤æœºåˆ¶ï¼šå³ä½¿éƒ¨åˆ†è„šæœ¬å¤±è´¥ï¼ŒæˆåŠŸç”Ÿæˆçš„æ–‡ä»¶ä¹Ÿä¼šè¢«æäº¤
#     5. å®Œå–„çš„é”™è¯¯æŠ¥å‘Šå’Œé‡è¯•æœºåˆ¶
#     6. ä»epg_scriptsåˆ†æ”¯è·å–è„šæœ¬
#     7. åœ¨ä¸´æ—¶ç›®å½•ä¸­ç›´æ¥æ‰§è¡Œè„šæœ¬
#     8. å°†ç”Ÿæˆçš„XMLæ–‡ä»¶å¤åˆ¶å›å·¥ä½œç›®å½•
#     9. æ”¯æŒPythonç¯å¢ƒé…ç½®å’Œä¾èµ–å®‰è£…
#     10. æ”¯æŒç¯å¢ƒå˜é‡é…ç½®ä¼ é€’
#
# ä½¿ç”¨è¯´æ˜:
#   1. å°†æœ¬æ–‡ä»¶æ”¾åœ¨ä»“åº“çš„ .github/workflows/ ç›®å½•
#   2. åœ¨ä¸‹é¢çš„è„šæœ¬åˆ—è¡¨ä¸­æ·»åŠ /ä¿®æ”¹éœ€è¦æ‰§è¡Œçš„PHPå’ŒPythonæ–‡ä»¶
#   3. ç¡®ä¿æ‰€æœ‰è„šæœ¬è¾“å‡º.xmlæ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
#   4. å·¥ä½œæµå°†è‡ªåŠ¨å¤„ç†XMLæ–‡ä»¶çš„æäº¤å’Œæ¨é€
#   5. è„šæœ¬å­˜å‚¨åœ¨epg_scriptsåˆ†æ”¯çš„æ ¹ç›®å½•

name: 3 Resilient Multi-Script EPG Generator (PHP + Python)

# è§¦å‘æ¡ä»¶é…ç½®
on:
  schedule:  # å®šæ—¶è§¦å‘é…ç½®
    # æ¯å¤©UTCæ—¶é—´1ç‚¹5åˆ†ã€5ç‚¹5åˆ†ã€9ç‚¹5åˆ†ã€13ç‚¹5åˆ†ã€17ç‚¹5åˆ†ã€21ç‚¹5åˆ†æ‰§è¡Œä¸€æ¬¡(åŒ—äº¬æ—¶é—´1ç‚¹5åˆ†ã€5ç‚¹5åˆ†ã€9ç‚¹5åˆ†ã€13ç‚¹5åˆ†ã€17ç‚¹5åˆ†ã€21ç‚¹5åˆ†)
    - cron: '5 1,5,9,13,17,21 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

# ä½œä¸šå®šä¹‰
jobs:
  generate-epg:  # ä½œä¸šID
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°ç‰ˆUbuntu
    timeout-minutes: 10
    
    # ç¯å¢ƒå˜é‡é…ç½®ï¼ˆä½œä¸šçº§åˆ«ï¼Œæ‰€æœ‰æ­¥éª¤éƒ½ä¼šç»§æ‰¿ï¼‰
    env:
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      EPG_CONFIG: ${{ secrets.EPG_CONFIG }}
      GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨PAT_TOKENè®¿é—®ç§æœ‰ä»“åº“
    
    # æ­¥éª¤å®šä¹‰
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç åº“ï¼ˆä½¿ç”¨PAT_TOKENï¼‰
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨PAT_TOKENæ£€å‡ºä»£ç 

    # æ­¥éª¤2: æ£€å‡ºepg_scriptsåˆ†æ”¯åˆ°ä¸´æ—¶ç›®å½•ï¼ˆä½¿ç”¨PAT_TOKENï¼‰
    - name: Checkout epg_scripts branch
      uses: actions/checkout@v4
      with:
        ref: epg_scripts
        path: ./epg-scripts-temp
        token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨PAT_TOKENæ£€å‡ºepg_scriptsåˆ†æ”¯

    # æ­¥éª¤3: è®¾ç½®PHPç¯å¢ƒ
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: dom, xmlreader, zlib, curl, pcntl

    # æ­¥éª¤4: è®¾ç½®Pythonç¯å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # æ­¥éª¤5: å®‰è£…Pythonä¾èµ–
    - name: Install Python dependencies
      run: |
        cd ./epg-scripts-temp
        pip install requests beautifulsoup4 tmdbv3api lxml aiohttp aiofiles
        cd ..

    # æ­¥éª¤6: åœ¨ä¸´æ—¶ç›®å½•ä¸­ç”ŸæˆXMLæ–‡ä»¶ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
    - name: Generate XML Files in Temp Directory
      id: generate-step
      env:
        # ç¡®ä¿è„šæœ¬èƒ½è®¿é—®åˆ°PAT_TOKEN
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # åˆ‡æ¢åˆ°ä¸´æ—¶ç›®å½•
        cd ./epg-scripts-temp
        
        # å®šä¹‰è¦æ‰§è¡Œçš„è„šæœ¬æ•°ç»„ï¼ˆPHPå’ŒPythonï¼‰
        scripts=(
          "epg-generator.php"      # PHP EPGç”Ÿæˆå™¨è„šæœ¬
          "epg-fixer.php"          # PHP EPGä¿®å¤å™¨è„šæœ¬ï¼ˆä»EPG_CONFIGè¯»å–é…ç½®ï¼‰
          # "epgguangxi.php"         # PHP å¹¿è¥¿EPGè„šæœ¬
          # "get_lstime_epg.py"      # Python é¾™ç¥¥æ—¶ä»£EPGè„šæœ¬
        )
        
        # å­˜å‚¨å¤±è´¥è„šæœ¬çš„æ•°ç»„
        failed_scripts=()
        
        # å¾ªç¯æ‰§è¡Œæ‰€æœ‰è„šæœ¬
        for script in "${scripts[@]}"; do
          echo "::group::æ‰§è¡Œ $script"
          echo "=== å¼€å§‹æ‰§è¡Œ: $script ==="
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$script" ]; then
            echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $script"
            failed_scripts+=("$script")
            echo "::endgroup::"
            continue
          fi
          
          # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©æ‰§è¡Œæ–¹å¼
          script_extension="${script##*.}"
          
          set +e  # ç¦ç”¨é”™è¯¯é€€å‡º
          
          if [ "$script_extension" = "php" ]; then
            # æ‰§è¡ŒPHPè„šæœ¬ï¼Œè‡ªåŠ¨ç»§æ‰¿ä½œä¸šçº§åˆ«çš„ç¯å¢ƒå˜é‡
            output=$(php -f "$script" 2>&1)
            exit_code=$?
          elif [ "$script_extension" = "py" ]; then
            # æ‰§è¡ŒPythonè„šæœ¬ï¼Œè‡ªåŠ¨ç»§æ‰¿ä½œä¸šçº§åˆ«çš„ç¯å¢ƒå˜é‡
            output=$(python "$script" 2>&1)
            exit_code=$?
          else
            echo "âŒ ä¸æ”¯æŒçš„è„šæœ¬ç±»å‹: $script_extension"
            failed_scripts+=("$script")
            set -e
            echo "::endgroup::"
            continue
          fi
          
          set -e  # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
          
          # æ‰“å°è„šæœ¬è¾“å‡º
          echo "$output"
          echo "::endgroup::"
          
          # å¤±è´¥åˆ¤å®šæ¡ä»¶ï¼ˆé’ˆå¯¹EPGä¿®å¤è„šæœ¬çš„ç‰¹æ®Šå¤„ç†ï¼‰
          if [ $exit_code -ne 0 ]; then
            echo "âŒ $script æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $exit_code)"
            failed_scripts+=("$script")
          elif [ "$script" = "epg-fixer.php" ]; then
            # å¯¹EPGä¿®å¤è„šæœ¬çš„ç‰¹æ®Šé”™è¯¯æ£€æµ‹
            # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœ€ç»ˆæˆåŠŸçŠ¶æ€
            if echo "$output" | grep -q "å¤„ç†çŠ¶æ€: æˆåŠŸ"; then
              echo "âœ… $script æ‰§è¡ŒæˆåŠŸï¼ˆé‡è¯•åæˆåŠŸï¼‰"
            elif echo "$output" | grep -q "å¤„ç†çŠ¶æ€: éƒ¨åˆ†æˆåŠŸ"; then
              # éƒ¨åˆ†æˆåŠŸä¸ç®—å®Œå…¨å¤±è´¥ï¼Œä½†éœ€è¦åœ¨æäº¤ä¿¡æ¯ä¸­æ³¨æ˜
              echo "âš ï¸ $script éƒ¨åˆ†æˆåŠŸï¼ˆæœ‰å¤±è´¥æºï¼‰"
              # è¿™é‡Œä¸åŠ å…¥failed_scriptsï¼Œå› ä¸ºéƒ¨åˆ†æ–‡ä»¶ç”ŸæˆæˆåŠŸ
            elif echo "$output" | grep -q "å¤„ç†çŠ¶æ€: å®Œå…¨å¤±è´¥"; then
              echo "âŒ $script æ‰€æœ‰æºå¤„ç†å¤±è´¥"
              failed_scripts+=("$script")
            # å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æœ€ç»ˆçŠ¶æ€ï¼Œå†æ£€æŸ¥å…¶ä»–é”™è¯¯
            elif echo "$output" | grep -q -E "(é”™è¯¯ï¼šEPG_CONFIGç¯å¢ƒå˜é‡æœªè®¾ç½®|é”™è¯¯ï¼šæ— æ³•è§£æEPG_CONFIGç¯å¢ƒå˜é‡ä¸­çš„JSONæ•°æ®|é”™è¯¯ï¼šEPG_CONFIGä¸­æœªæ‰¾åˆ°chuanliu.xmlå’Œcqunicom.xmlé…ç½®|é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„EPGæºé…ç½®|é”™è¯¯ï¼šå¿…éœ€æ‰©å±•æœªå¯ç”¨)"; then
              echo "âŒ $script ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯"
              failed_scripts+=("$script")
            elif echo "$output" | grep -q -E "(Fatal error|è‡´å‘½é”™è¯¯|Uncaught Exception|æœªæ•è·çš„å¼‚å¸¸|æ— æ³•åŠ è½½XMLå†…å®¹|XMLè§£æé”™è¯¯|è§£å‹å¤±è´¥|ä¿å­˜å¤±è´¥)"; then
              # æ³¨æ„ï¼šç§»é™¤äº†"ä¸‹è½½å¤±è´¥"æ£€æŸ¥ï¼Œå› ä¸ºå¯èƒ½æœ‰é‡è¯•æˆåŠŸçš„æƒ…å†µ
              echo "âŒ $script æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°ä¸¥é‡é”™è¯¯"
              failed_scripts+=("$script")
            else
              echo "âœ… $script æ‰§è¡ŒæˆåŠŸ"
            fi
          elif echo "$output" | grep -q -E "(Fatal error|è‡´å‘½é”™è¯¯|Uncaught Exception|æœªæ•è·çš„å¼‚å¸¸|å¿…éœ€æ‰©å±•æœªå¯ç”¨|æ— æ³•åŠ è½½XMLå†…å®¹|XMLè§£æé”™è¯¯|ä¸‹è½½å¤±è´¥|è§£å‹å¤±è´¥|ä¿å­˜å¤±è´¥|Traceback|Error|Exception)"; then
            echo "âŒ $script è¾“å‡ºä¸­åŒ…å«ä¸¥é‡é”™è¯¯ä¿¡æ¯"
            failed_scripts+=("$script")
          elif echo "$output" | grep -q -E "(ERROR|é”™è¯¯:)" && echo "$output" | grep -q -E "(ä¸‹è½½|è§£å‹|ä¿å­˜|å¤„ç†|è·å–|è¿æ¥)"; then
            echo "âŒ $script è¾“å‡ºä¸­åŒ…å«æ“ä½œé”™è¯¯ä¿¡æ¯"
            failed_scripts+=("$script")
          else
            echo "âœ… $script æ‰§è¡ŒæˆåŠŸ"
          fi
          
          echo "==================================="
        done
        
        # å°†ç”Ÿæˆçš„XMLæ–‡ä»¶å¤åˆ¶å›å·¥ä½œç›®å½•
        if ls *.xml 1> /dev/null 2>&1; then
          echo "ğŸ›  å¤åˆ¶XMLæ–‡ä»¶åˆ°å·¥ä½œç›®å½•..."
          cp -v *.xml ../
          echo "ğŸ“ å¤åˆ¶çš„æ–‡ä»¶:"
          ls -la *.xml
        else
          echo "âš ï¸ æœªæ‰¾åˆ°XMLæ–‡ä»¶"
        fi
        
        # è¿”å›å·¥ä½œç›®å½•
        cd ..
        
        # å¦‚æœæœ‰å¤±è´¥è„šæœ¬ï¼Œè½¬æ¢ä¸ºé€—å·åˆ†éš”å­—ç¬¦ä¸²
        if [ ${#failed_scripts[@]} -gt 0 ]; then
          failed_list=$(IFS=','; echo "${failed_scripts[*]}")
          echo "ğŸ“„ å¤±è´¥è„šæœ¬: $failed_list"
          echo "failed_scripts=$failed_list" >> $GITHUB_OUTPUT
        fi

    # æ­¥éª¤7: åˆ—å‡ºå˜æ›´çš„æ–‡ä»¶
    - name: List changed files
      run: |
        echo "ğŸ“ ä»¥ä¸‹æ–‡ä»¶æœ‰å˜æ›´:"
        git status --porcelain
        echo "ğŸ— å½“å‰ç›®å½•çš„XMLæ–‡ä»¶:"
        ls -la *.xml 2>/dev/null || echo "âš ï¸ æ— XMLæ–‡ä»¶"

    # æ­¥éª¤8: æäº¤å’Œæ¨é€å˜æ›´ï¼ˆä½¿ç”¨PAT_TOKENï¼‰
    - name: Commit and Push Changes
      if: always()
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # è®¾ç½®å¸¦è®¤è¯çš„è¿œç¨‹URLï¼ˆä½¿ç”¨PAT_TOKENï¼‰
        git remote set-url origin https://x-access-token:$PAT_TOKEN@github.com/$GITHUB_REPOSITORY.git
        
        # æ·»åŠ æ‰€æœ‰XMLæ–‡ä»¶å˜æ›´
        git add --all *.xml
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
        if git diff-index --quiet HEAD --; then
          echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°XMLæ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        # è·å–å¤±è´¥è„šæœ¬ä¿¡æ¯
        failed_scripts="${{ steps.generate-step.outputs.failed_scripts }}"
        
        # æ„é€ æäº¤ä¿¡æ¯
        now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        commit_msg="âœ… è‡ªåŠ¨æ›´æ–° EPG æ–‡ä»¶: $now_time"
        
        # å¦‚æœæœ‰å¤±è´¥è„šæœ¬ï¼Œåœ¨æäº¤ä¿¡æ¯ä¸­æ³¨æ˜
        if [ -n "$failed_scripts" ]; then
          commit_msg+=" (âš ï¸ éƒ¨åˆ†å¤±è´¥: ${failed_scripts})"
        fi
        
        # æäº¤å˜æ›´
        echo "â„¹ï¸ æäº¤ä¿¡æ¯: $commit_msg"
        git commit -m "$commit_msg"
        
        # æ¨é€é‡è¯•æœºåˆ¶
        max_retries=3
        retry_delay=5
        
        for ((i=1; i<=max_retries; i++)); do
          echo "â„¹ï¸ æ¨é€å°è¯• ($i/$max_retries)"
          
          # å…ˆæ‹‰å–æœ€æ–°å˜æ›´é¿å…å†²çª
          git pull --rebase origin ${GITHUB_REF#refs/heads/}
          
          # å°è¯•æ¨é€
          if git push origin HEAD:${GITHUB_REF#refs/heads/}; then
            echo "âœ… æ¨é€æˆåŠŸ"
            
            # åˆ—å‡ºæ›´æ–°çš„æ–‡ä»¶
            updated_files=$(git diff --name-only HEAD^ HEAD 2>/dev/null || git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å˜æ›´åˆ—è¡¨")
            echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
            echo "$updated_files"
            
            break
          fi
          
          if [ $i -eq $max_retries ]; then
            echo "âŒ é”™è¯¯ï¼šæ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
            exit 1
          fi
          
          echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œ${retry_delay}ç§’åé‡è¯•..."
          sleep $retry_delay
        done

    # æ­¥éª¤9: æŠ¥å‘Šç”ŸæˆçŠ¶æ€ï¼ˆä¿®æ”¹åç‰ˆæœ¬ - æœ‰å¤±è´¥è„šæœ¬æ—¶å·¥ä½œæµå¤±è´¥ï¼‰
    - name: Report Generation Status
      if: ${{ always() }}
      run: |
        failed_scripts="${{ steps.generate-step.outputs.failed_scripts }}"
        
        if [ -n "$failed_scripts" ]; then
          IFS=',' read -ra failed_array <<< "$failed_scripts"
          
          echo "::group::âŒ å¤±è´¥è„šæœ¬åˆ—è¡¨"
          for script in "${failed_array[@]}"; do
            echo "$script"
          done
          echo "::endgroup::"
          
          echo "::error::æœ‰ ${#failed_array[@]} ä¸ªè„šæœ¬æ‰§è¡Œå¤±è´¥"
          
          # æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªè„šæœ¬æˆåŠŸç”Ÿæˆäº†æ–‡ä»¶
          if ls *.xml 1> /dev/null 2>&1; then
            echo "â„¹ï¸ æœ‰è„šæœ¬å¤±è´¥ï¼Œå·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥"
            echo "â„¹ï¸ æˆåŠŸç”Ÿæˆäº†éƒ¨åˆ†EPGæ–‡ä»¶"
          else
            echo "âŒ æ‰€æœ‰è„šæœ¬å‡å¤±è´¥ï¼Œæ— EPGæ–‡ä»¶ç”Ÿæˆ"
          fi
          
          # å…³é”®ä¿®æ”¹ï¼šåªè¦æœ‰è„šæœ¬å¤±è´¥ï¼Œå·¥ä½œæµå°±å¤±è´¥
          exit 1
        else
          echo "âœ… æ‰€æœ‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        fi