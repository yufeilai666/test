name: 3 Generate EPG XML

###############################################################################
# EPGæ•°æ®è‡ªåŠ¨ç”Ÿæˆå·¥ä½œæµ
# 
# åŠŸèƒ½æ¦‚è¿°:
#   - ä»ç§æœ‰ä»“åº“è·å–EPGç”Ÿæˆè„šæœ¬ï¼ˆPHP/Pythonï¼‰
#   - è‡ªåŠ¨æ‰§è¡Œè„šæœ¬ç”ŸæˆXMLæ ¼å¼çš„ç”µå­èŠ‚ç›®æŒ‡å—æ•°æ®
#   - å°†ç”Ÿæˆçš„EPGæ•°æ®æ¨é€åˆ°å½“å‰ä»“åº“çš„epgç›®å½•
#
# ä¸»è¦ç‰¹æ€§:
#   - æ”¯æŒå¤šè¯­è¨€å¤šè„šæœ¬ï¼ˆPHP 8.1 + Python 3.9ï¼‰
#   - å®‰å…¨çš„ç§æœ‰ä»“åº“è®¿é—®ï¼ˆä½¿ç”¨PAT_TOKENï¼‰
#   - è‡ªåŠ¨é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Šæœºåˆ¶
#   - è„šæœ¬æ‰§è¡Œåè‡ªåŠ¨æ¸…ç†ï¼Œä¸ä¿ç•™åœ¨å…¬å…±ä»“åº“
#   - åŒ—äº¬æ—¶é—´æˆ³çš„æäº¤ä¿¡æ¯
#   - å¯é…ç½®çš„è„šæœ¬æ‰§è¡Œåˆ—è¡¨
#
# è§¦å‘æ¡ä»¶:
#   - å®šæ—¶è§¦å‘: æ¯æ—¥UTC 22:10ï¼ˆåŒ—äº¬æ—¶é—´06:10ï¼‰è‡ªåŠ¨è¿è¡Œ
#   - æ‰‹åŠ¨è§¦å‘: å¯åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨æ‰§è¡Œ
#
# å‰ç½®è¦æ±‚:
#   - åœ¨ä»“åº“Secretsä¸­è®¾ç½®PAT_TOKENï¼Œå…·æœ‰è®¿é—®ç§æœ‰ä»“åº“çš„æƒé™
#   - ç§æœ‰ä»“åº“tvepgçš„epg_scriptsåˆ†æ”¯åŒ…å«æ‰€éœ€çš„EPGè„šæœ¬
#
# è¾“å‡ºç»“æœ:
#   - ç”Ÿæˆçš„XMLæ–‡ä»¶å°†ä¿å­˜åœ¨epgç›®å½•ä¸­
#   - è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯æŠ¥å‘Š
###############################################################################

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ - å¯åœ¨GitHub Actionsé¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  schedule:
    # å®šæ—¶è§¦å‘ - æ¯å¤©UTCæ—¶é—´22ç‚¹10åˆ†ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹10åˆ†ï¼‰è‡ªåŠ¨è¿è¡Œ
    - cron: '10 22 * * *'

jobs:
  generate-epg:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°ç‰ˆUbuntuç³»ç»Ÿä½œä¸ºè¿è¡Œç¯å¢ƒ
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œè¿›è¡Œè®¤è¯
        fetch-depth: 1  # è·å–æœ€æ–°gitå†å²è®°å½•

    # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # æŒ‡å®šPython 3.9ç‰ˆæœ¬

    # æ­¥éª¤3: è®¾ç½®PHPç¯å¢ƒ
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'  # æŒ‡å®šPHP 8.1ç‰ˆæœ¬
        
    # æ­¥éª¤4: å®‰è£…Pythonä¾èµ–åŒ…
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip  # å‡çº§pipåˆ°æœ€æ–°ç‰ˆæœ¬
        # å®‰è£…Pythonè„šæœ¬å¯èƒ½éœ€è¦çš„åº“
        pip install requests beautifulsoup4 lxml pytz httpx loguru

    # æ­¥éª¤5: å®‰è£…PHPæ‰©å±•
    - name: Install PHP dependencies
      run: |
        # æ›´æ–°åŒ…ç®¡ç†å™¨
        sudo apt-get update
        # å®‰è£…PHPè„šæœ¬å¯èƒ½éœ€è¦çš„æ‰©å±•
        sudo apt-get install -y php-curl php-xml php-mbstring        

    # æ­¥éª¤6: ç›´æ¥æ£€å‡ºç§æœ‰ä»“åº“çš„epg_scriptsåˆ†æ”¯
    - name: Checkout private repository (epg_scripts branch)
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository_owner }}/tvepg  # ç§æœ‰ä»“åº“
        token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ä¸ªäººè®¿é—®ä»¤ç‰Œ
        ref: epg_scripts  # æŒ‡å®šåˆ†æ”¯
        path: private_repo_temp  # æ£€å‡ºåˆ°æŒ‡å®šç›®å½•

    # æ­¥éª¤6.5: å¤åˆ¶ä¾èµ–è„šæœ¬åˆ°å·¥ä½œç›®å½•ï¼ˆä¸æäº¤åˆ°ä»“åº“ï¼‰
    - name: Copy dependency scripts
      id: copy-deps
      run: |
        # å®šä¹‰ä¾èµ–è„šæœ¬æ•°ç»„ - åªéœ€åœ¨æ­¤å¤„å®šä¹‰ä¸€æ¬¡
        dependency_scripts=(
          # Pythonä¾èµ–è„šæœ¬
          "bbcable_backup_channels_dict.py"
          "tvmao_channels_list.py"
          # å¯ä»¥æ·»åŠ æ›´å¤šä¾èµ–è„šæœ¬
          # "config.json"  # å¦‚æœéœ€è¦é…ç½®æ–‡ä»¶ï¼Œå–æ¶ˆæ³¨é‡Š
          # "another_dependency.py"
        )
        
        echo "ğŸ± ä¾èµ–è„šæœ¬æ•°é‡: ${#dependency_scripts[@]}"
        
        # å°†æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
        for dep_script in "${dependency_scripts[@]}"; do
          echo "$dep_script"
        done > /tmp/dependency_scripts.txt
        
        # å¾ªç¯å¤åˆ¶æ¯ä¸ªä¾èµ–è„šæœ¬
        for dep_script in "${dependency_scripts[@]}"; do
          echo "ğŸ“‹ å¤åˆ¶ä¾èµ–è„šæœ¬: $dep_script"
          # æ£€æŸ¥è„šæœ¬åœ¨ç§æœ‰ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨
          if [ -f "private_repo_temp/$dep_script" ]; then
            # å¤åˆ¶ä¾èµ–è„šæœ¬åˆ°å½“å‰å·¥ä½œç›®å½•
            cp "private_repo_temp/$dep_script" "./$dep_script"
            echo "âœ… å·²å¤åˆ¶ $dep_script"
          else
            echo "âš ï¸ è­¦å‘Š: ä¾èµ–è„šæœ¬ $dep_script ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
        done
        
        # è¾“å‡ºä¾èµ–è„šæœ¬æ•°é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "dependency_count=${#dependency_scripts[@]}" >> $GITHUB_OUTPUT

    # æ­¥éª¤7: å®šä¹‰å¹¶æ‰§è¡Œè„šæœ¬æ•°ç»„
    - name: Define and execute scripts
      run: |
        # å®šä¹‰è¦è·å–å¹¶æ‰§è¡Œçš„è„šæœ¬æ•°ç»„ï¼ˆPHPå’ŒPythonï¼‰
        # å¯ä»¥è½»æ¾æ·»åŠ ã€ç§»é™¤æˆ–æ³¨é‡Šä¸éœ€è¦çš„è„šæœ¬
        scripts=(
          "epganywhereusa.php"
          # "epg-fixer.php"          # PHP EPGä¿®å¤å™¨è„šæœ¬ï¼ˆä»EPG_CONFIGè¯»å–é…ç½®ï¼‰- å½“å‰å·²ç¦ç”¨
          # "epgguangxi.php"         # PHP å¹¿è¥¿EPGè„šæœ¬ - å½“å‰å·²ç¦ç”¨
          "get_mytvsuper_epg.py"      # Python mytvsuper EPGè„šæœ¬ - å½“å‰å¯ç”¨
          "get_asiasatv_epg.py"
          "get_tvmao_epg.py"
        )
        
        # å­˜å‚¨å¤±è´¥è„šæœ¬çš„æ•°ç»„ï¼Œç”¨äºé”™è¯¯æŠ¥å‘Š
        failed_scripts=()
        
        # å¾ªç¯æ‰§è¡Œæ¯ä¸ªè„šæœ¬
        for script in "${scripts[@]}"; do
          echo "::group::ğŸ›  æ‰§è¡Œ $script"
          
          # æ£€æŸ¥è„šæœ¬åœ¨ç§æœ‰ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨
          if [ ! -f "private_repo_temp/$script" ]; then
            echo "âš ï¸ è­¦å‘Š: è„šæœ¬ $script ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            failed_scripts+=("$script (ä¸å­˜åœ¨)")
            echo "::endgroup::"
            continue
          fi
          
          # å¤åˆ¶è„šæœ¬ä»ä¸´æ—¶ç›®å½•åˆ°å½“å‰å·¥ä½œç›®å½•
          cp "private_repo_temp/$script" "./$script"
          
          # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©æ‰§è¡Œæ–¹å¼
          if [[ "$script" == *.php ]]; then
            # æ‰§è¡ŒPHPè„šæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™è®°å½•é”™è¯¯
            php "$script" || {
              echo "âŒ é”™è¯¯: PHPè„šæœ¬ $script æ‰§è¡Œå¤±è´¥"
              failed_scripts+=("$script")
              rm -f "$script"  # æ¸…ç†è„šæœ¬æ–‡ä»¶
              echo "::endgroup::"
              continue
            }
          elif [[ "$script" == *.py ]]; then
            # æ‰§è¡ŒPythonè„šæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™è®°å½•é”™è¯¯
            python "$script" || {
              echo "âŒ é”™è¯¯: Pythonè„šæœ¬ $script æ‰§è¡Œå¤±è´¥"
              failed_scripts+=("$script")
              rm -f "$script"  # æ¸…ç†è„šæœ¬æ–‡ä»¶
              echo "::endgroup::"
              continue
            }
          fi
          
          # æ‰§è¡ŒæˆåŠŸååˆ é™¤è„šæœ¬æ–‡ä»¶ï¼Œä¸ä¿ç•™åœ¨ä»“åº“ä¸­
          rm -f "$script"
          echo "âœ… è„šæœ¬ $script æ‰§è¡ŒæˆåŠŸ"
          echo "::endgroup::"
        done
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•ï¼Œä¸ä¿ç•™ç§æœ‰ä»“åº“çš„å‰¯æœ¬
        rm -rf private_repo_temp
        
        # æŠ¥å‘Šæ‰€æœ‰è„šæœ¬çš„æ‰§è¡Œç»“æœ
        echo "=== è„šæœ¬æ‰§è¡Œç»“æœ ==="
        if [ ${#failed_scripts[@]} -eq 0 ]; then
          echo "âœ… æ‰€æœ‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ!"
        else
          echo "â„¹ï¸ ä»¥ä¸‹è„šæœ¬æ‰§è¡Œå¤±è´¥:"
          for failed in "${failed_scripts[@]}"; do
            echo "  - $failed"
          done
          # å¦‚æœæœ‰è„šæœ¬å¤±è´¥ï¼Œé€€å‡ºçŠ¶æ€ä¸ºéé›¶ï¼Œä½¿å·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥
          exit 1
        fi

    # æ­¥éª¤8: æ¸…ç†ä¾èµ–è„šæœ¬ï¼ˆç¡®ä¿ä¸æäº¤åˆ°ä»“åº“ï¼‰
    - name: Clean up dependency scripts
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¾èµ–è„šæœ¬..."
        echo "â„¹ï¸ æ‰¾åˆ° ${{ steps.copy-deps.outputs.dependency_count }} ä¸ªä¾èµ–è„šæœ¬éœ€è¦æ¸…ç†"
        
        # æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f /tmp/dependency_scripts.txt ]; then
          # ä»ä¸´æ—¶æ–‡ä»¶è¯»å–ä¾èµ–è„šæœ¬åˆ—è¡¨å¹¶æ¸…ç†
          while IFS= read -r dep_script || [ -n "$dep_script" ]; do
            if [ -n "$dep_script" ] && [ -f "$dep_script" ]; then
              rm -f "$dep_script"
              echo "âœ… å·²åˆ é™¤ $dep_script"
            fi
          done < /tmp/dependency_scripts.txt
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/dependency_scripts.txt
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ä¾èµ–è„šæœ¬åˆ—è¡¨æ–‡ä»¶ï¼Œå°è¯•ç›´æ¥æ¸…ç†å¸¸è§ä¾èµ–è„šæœ¬..."
          # å¦‚æœä¸´æ—¶æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•æ¸…ç†ä¸€äº›å¸¸è§çš„ä¾èµ–è„šæœ¬
          common_deps=("bbcable_backup_channels_dict.py" "tvmao_channels_list.py")
          for dep_script in "${common_deps[@]}"; do
            if [ -f "$dep_script" ]; then
              rm -f "$dep_script"
              echo "âœ… å·²åˆ é™¤ $dep_script"
            fi
          done
        fi
        
        echo "âœ… ä¾èµ–è„šæœ¬æ¸…ç†å®Œæˆ"

    # æ­¥éª¤9: åˆ›å»ºepgç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    - name: Create epg directory if not exists
      run: |
        mkdir -p epg  # åˆ›å»ºepgç›®å½•ç”¨äºå­˜æ”¾ç”Ÿæˆçš„XMLæ–‡ä»¶

    # æ­¥éª¤10: ç§»åŠ¨XMLæ–‡ä»¶åˆ°epgç›®å½•
    - name: Move XML files to epg directory
      run: |
        # æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰XMLå’ŒXML.GZæ–‡ä»¶å¹¶ç§»åŠ¨åˆ°epgç›®å½•
        # æ”¯æŒå¸¸è§„XMLæ–‡ä»¶å’Œå‹ç¼©çš„XML.GZæ–‡ä»¶
        find . -maxdepth 1 -name "*.xml" -exec mv {} epg/ \; 2>/dev/null || echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°XMLæ–‡ä»¶"
        find . -maxdepth 1 -name "*.xml.gz" -exec mv {} epg/ \; 2>/dev/null || echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°XML.GZæ–‡ä»¶"

    # æ­¥éª¤11: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"  # è®¾ç½®æäº¤è€…åç§°
        git config user.email "actions@github.com"  # è®¾ç½®æäº¤è€…é‚®ç®±

    # æ­¥éª¤12: è·å–åŒ—äº¬æ—¶é—´å¹¶æäº¤æ›´æ”¹
    - name: Get Beijing time and commit changes
      run: |
        # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´å¹¶è·å–æ ¼å¼åŒ–çš„æ—¶é—´å­—ç¬¦ä¸²
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')
        # æ·»åŠ epgç›®å½•ä¸‹çš„æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒº
        git add epg/
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "â„¹ï¸ æ²¡æœ‰æ›´æ”¹å¯æäº¤"
        else
          # æäº¤æ›´æ”¹ï¼ŒåŒ…å«åŒ—äº¬æ—¶é—´ä¿¡æ¯
          git commit -m "ğŸ”„ Download EPGæ•°æ® [åŒ—äº¬æ—¶é—´: $BEIJING_TIME]"
          # æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
          git push
          echo "âœ… Push successful"
        fi